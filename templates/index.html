<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</title>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="nav">
                <img class="logo" src="static/img/logo.svg">
                <input class="search_input" type="text" name="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞" value="{{ request.args.get('search', '') }}">
            </div>
        </div>
    </header>

    <section class="stuff_section">
        <div class="container">
            <h2>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
            <div class="stuff_grid">
                {%if not stuff %}
                <h3>–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                {% else %}
                {% for item in stuff %}
                    <div class="stuff_card">
                        <h3>{{ item.name }}</h3>
                        <p>{{ item.post }}</p>
                        <p>email</p>
                        <p>{{ item.phone }}</p>
                        <div class="qr_btns">
                            <p> {{ item.bdate}} </p>
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ QR-–∫–æ–¥–∞ -->
                            <button onclick="generateQr('{{ item.name }}', '{{ item.email }}', '{{ item.phone }}', '{{ item.post }}', {{ loop.index }})">üéû</button>
                        </div>
                        <!-- –ú–µ—Å—Ç–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è QR-–∫–æ–¥–∞ -->
                        <div id="qr-{{ loop.index }}" class="qr-code" style="display:none;">
                            <img id="qr-img-{{ loop.index }}" src="" alt="QR-–∫–æ–¥">
                        </div>
                    </div>
                {% endfor %}
                {%endif%}
            </div>
        </div>
    </section>

    <section class="main_section">
        <div class="container">
            <div class="main_frame">
                <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π -->
                <div class="events_frame">
                    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π</h2>
                    <form method="POST" class = "calendar_frame">
                        <div class="calendar_header">
                            <button type="submit" name="prev" class="calendar-button">‚¨Ö</button>
                            <h2>{{ month_name }} {{ year }}</h2>
                            <button type="submit" name="next" class="calendar-button">‚û°</button>
                        </div>
                        <input type="hidden" name="year" value="{{ year }}">
                        <input type="hidden" name="month" value="{{ month }}">
    
                        <table class="calendar_table">
                            <thead>
                                <tr>
                                    <th>–ü–Ω</th>
                                    <th>–í—Ç</th>
                                    <th>–°—Ä</th>
                                    <th>–ß—Ç</th>
                                    <th>–ü—Ç</th>
                                    <th>–°–±</th>
                                    <th>–í—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in calendar %}
                                    <tr>
                                        {% for day in week %}
                                            {% if day != 0 %}  {# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–µ–Ω—å –Ω–µ —Ä–∞–≤–µ–Ω 0 #}
                                                {% set date_str = '{:04d}-{:02d}-{:02d}'.format(year, month, day) %}
                                                {% set is_today = (day == now.day and month == now.month and year == now.year) %}
                                                {% set is_non_working = date_str in non_working_days %}
                                                {% set event_count_today = event_count.get(datetime(year, month, day).date(), 0) %}
                                                <td id="{% if event_count_today >= 5 %}multiple-events{% elif event_count_today < 2 %}low-event{% else %}mid-event{% endif %}" 
                                                    class="{% if is_today %}current-day{% endif %} {% if is_non_working %}non-working-day{% endif %}">
                                                    {{ day }}
                                                </td>
                                            {% else %}
                                                <td class="empty-day"></td>  {# –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –¥–ª—è –¥–Ω–µ–π, —Ä–∞–≤–Ω—ã—Ö 0 #}
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>                                                    
                        </table>
                    </form>
                    
                    <h2>–°–æ–±—ã—Ç–∏—è</h2>

                    {% for item in events %}
                        <div class="event_card">
                            <h5 class="title">{{ item.name }}</h5>
                            <p class="description">{{ item.discription }}</p>
                            <div class="footer_event">
                                <button class="download_event_btn" onclick="downloadEvent('{{ item.id }}')">üì•</button>
                                <p>{{ item.ev_date }}</p>
                                <p>{{ item.author_name }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
    
                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ -->
                <div class="news_frame">
                    <h1 class="test">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h1>
                    <div class="news-grid">
                        {% for item in news %}
                            <div class="news-item">
                                <h2>{{ item.title }}</h2>
                                <p>{{ item.summary }}</p>
                                <a href="{{ item.link }}" target="_blank">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    

    <script>
        function downloadEvent(event) {
            const url = `/download_event?summary=${encodeURIComponent(event.name)}&start=${encodeURIComponent(event.ev_date)}&description=${encodeURIComponent(event.description || '')}&location=${encodeURIComponent(event.location || '')}&organizer=${encodeURIComponent(event.author_name || '')}`;
            window.location.href = url;
        }
    </script>
    

    <script>
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
        function generateQr(name, email, phone, position, index) {
            // –ù–∞—Ö–æ–¥–∏–º div —Å qr-–∫–æ–¥–æ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
            const qrDiv = document.getElementById('qr-' + index);
            const qrImg = document.getElementById('qr-img-' + index);

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ QR-–∫–æ–¥–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const qrUrl = `/generate_qr?name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&position=${encodeURIComponent(position)}`;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            qrImg.src = qrUrl;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º QR-–∫–æ–¥–∞
            qrDiv.style.display = 'block';
        }
    </script>

    <script>
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–∏—Å–∫–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.querySelector('.search_input').addEventListener('input', function() {
            const searchValue = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('search', searchValue);  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∏—Å–∫–∞
            window.location.href = url.toString();  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π URL —Å –ø–æ–∏—Å–∫–æ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
        });

    </script>
</body>
</html>
